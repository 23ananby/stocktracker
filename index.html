<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Market Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --text-color: #e0e0e0;
            --text-secondary-color: #a0a0a0;
            --positive-color: #26a69a;
            --negative-color: #ef5350;
            --neutral-color: var(--text-secondary-color);
            --border-color: #444;
            --button-bg: #333;
            --button-hover-bg: #444;
            --chart-grid-color-val: rgba(255, 255, 255, 0.1);
            --chart-line-color-val: #26a69a;
            --chart-tick-color-val: #a0a0a0;
            --font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            --modal-bg: rgba(0, 0, 0, 0.7);
            --modal-content-bg: #2a2a2a;
            --swipe-delete-bg: var(--negative-color);
            --swipe-edit-bg: var(--positive-color);
            --link-color: #42a5f5;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: var(--font-family); display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; padding: 20px; font-size: 14px; }
        .container { background-color: #2a2a2a; border-radius: 8px; padding: 20px; max-width: 400px; width: 100%; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); overflow: hidden; }
        header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .header-main { flex-grow: 1; } .header-main h1 { font-size: 2.5em; font-weight: bold; line-height: 1; margin-bottom: 2px; } .header-main p { color: var(--text-secondary-color); font-size: 0.9em; }
        .header-actions { display: flex; align-items: center; flex-shrink: 0; }
        .header-actions button { background-color: var(--button-bg); color: var(--text-color); border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 0.85em; margin-left: 8px; transition: background-color 0.2s ease; white-space: nowrap; } .header-actions button:hover { background-color: var(--button-hover-bg); }
        /* Old price-info styles can be removed if not needed */
        /* .price-info { display: flex; justify-content: space-between; margin-bottom: 8px; align-items: flex-start; }
        .price-block { flex: 1; padding-right: 5px; } .price-block:last-child { padding-right: 0; text-align: right; display: flex; flex-direction: column; align-items: flex-end; } .price-block .value-line { display: flex; align-items: baseline; justify-content: flex-start; min-height: 1.2em; } .price-block:last-child .value-line { justify-content: flex-end; } .price-block .price { font-size: 1.8em; font-weight: 500; line-height: 1; margin-right: 5px; } .price-block .change { font-size: 1.1em; font-weight: 500; line-height: 1; } .price-block .change.positive { color: var(--positive-color); } .price-block .change.negative { color: var(--negative-color); } .price-block .label { display: block; color: var(--text-secondary-color); font-size: 0.9em; margin-top: 4px; } */
        .currency-selector-container { color: var(--text-secondary-color); font-size: 0.9em; margin-bottom: 20px; display: flex; align-items: center; } .currency-selector-container label { margin-right: 5px; }
        #currencySelector { background-color: var(--button-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 4px; padding: 2px 5px; font-size: 1em; cursor: pointer; -webkit-appearance: none; -moz-appearance: none; appearance: none; } #currencySelector:focus { outline: none; box-shadow: none; }
        .chart-area { height: 200px; margin-bottom: 25px; position: relative; }
        .transaction-list { margin-bottom: 20px; min-height: 80px; }
        .transaction-item-wrapper { position: relative; overflow: hidden; background-color: var(--modal-content-bg); user-select: none; touch-action: pan-y; border-bottom: 1px solid var(--border-color); } .transaction-item-wrapper:last-child { border-bottom: none;}
        .transaction-item-swipe-background { position: absolute; top: 0; bottom: 0; width: 100%; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; color: white; font-weight: bold; opacity: 0; transition: opacity 0.1s ease-out; } .swipe-delete { background-color: var(--swipe-delete-bg); justify-content: flex-end; } .swipe-edit { background-color: var(--swipe-edit-bg); justify-content: flex-start; }
        .transaction-item { display: grid; grid-template-columns: auto 1fr auto auto; gap: 10px; padding: 12px 10px; align-items: center; font-size: 0.95em; background-color: var(--modal-content-bg); position: relative; transition: transform 0.1s ease-out; cursor: grab; } .transaction-item.dragging { cursor: grabbing; transition: none; } .transaction-item span:nth-child(1) { font-weight: 600; } .transaction-item span:nth-child(2) { text-align: right; font-weight: 600; } .transaction-item span.result.positive { color: var(--positive-color); } .transaction-item span.result.negative { color: var(--negative-color); } .transaction-item span.result.neutral { color: var(--neutral-color); } .transaction-item span:nth-child(3) { color: var(--text-secondary-color); font-size: 0.85em; text-align: right; } .transaction-item span:nth-child(4) { text-align: right; font-weight: 500; min-width: 50px; } .no-transactions { color: var(--text-secondary-color); text-align: center; padding: 20px 0; font-style: italic; }
        footer p { color: var(--link-color); font-size: 0.9em; display: block; text-align: left; margin-top: 10px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: var(--modal-bg); align-items: center; justify-content: center; } .modal-content { background-color: var(--modal-content-bg); margin: auto; padding: 25px; border: 1px solid var(--border-color); width: 80%; max-width: 450px; border-radius: 8px; color: var(--text-color); box-shadow: 0 5px 15px rgba(0,0,0,0.5); } .modal-content h2 { margin-top: 0; margin-bottom: 20px; font-weight: 500; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; } .modal-content label { display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--text-secondary-color); } .modal-content input[type="text"], .modal-content input[type="number"], .modal-content input[type="datetime-local"], .modal-content select { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--button-bg); color: var(--text-color); font-size: 1em; } .modal-content input[type="number"]::-webkit-inner-spin-button, .modal-content input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; } .modal-content input[type="number"] { -moz-appearance: textfield; } .modal-actions { text-align: right; margin-top: 20px; } .modal-actions button { background-color: var(--button-bg); color: var(--text-color); border: none; padding: 10px 18px; border-radius: 5px; cursor: pointer; font-size: 0.9em; margin-left: 10px; transition: background-color 0.2s ease; } .modal-actions button.primary { background-color: var(--positive-color); color: #fff; } .modal-actions button.primary:hover { background-color: #1e8e84; } .modal-actions button:hover { background-color: var(--button-hover-bg); } .close-button { color: var(--text-secondary-color); float: right; font-size: 24px; font-weight: bold; line-height: 1; cursor: pointer; margin-top: -10px; } .close-button:hover, .close-button:focus { color: var(--text-color); text-decoration: none; }

        /* --- START: Finance Card Styles --- */
        .finance-card {
            background: linear-gradient(160deg, #404040, #2d2d2d); /* Dark gradient background */
            border-radius: 15px; /* Rounded corners */
            padding: 20px;
            color: var(--text-color);
            position: relative;
            margin-bottom: 25px; /* Spacing below card */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            overflow: hidden; /* Keep elements inside rounded corners */
            font-family: var(--font-family);
        }

        .finance-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px; /* Space below header */
        }

        /* Mastercard-like logo using pseudo-elements */
        .finance-card .card-logo {
            width: 45px;
            height: 28px;
            position: relative;
        }
        .finance-card .card-logo::before,
        .finance-card .card-logo::after {
            content: '';
            position: absolute;
            top: 0;
            width: 28px;
            height: 28px;
            border-radius: 50%;
        }
        .finance-card .card-logo::before {
            left: 0;
            background-color: rgba(255, 255, 255, 0.4); /* Semi-transparent white/grey */
            z-index: 1;
        }
        .finance-card .card-logo::after {
            left: 17px; /* Overlap */
            background-color: rgba(255, 255, 255, 0.3); /* Slightly different transparency */
            z-index: 2;
        }

        .finance-card .card-wallet-icon svg {
            display: block; /* Prevents extra space below SVG */
            color: rgba(255, 255, 255, 0.8); /* White icon color */
        }

        .finance-card .card-body {
            margin-bottom: 25px; /* Space below main balance */
            text-align: left;
        }

        .finance-card .card-balance-primary {
            display: flex;
            align-items: baseline;
            margin-bottom: 4px; /* Space between value and label */
        }

        .finance-card .card-balance-primary #totalCapitalization {
            font-size: 2.3em; /* Larger font for main balance */
            font-weight: 500;
            line-height: 1.1;
            letter-spacing: 0.5px; /* Slight letter spacing */
            margin-right: 8px;
        }

        .finance-card .card-balance-primary .change {
            font-size: 1em; /* Adjust size as needed */
            font-weight: 500;
        }
        /* Ensure percentage colors work */
        .finance-card .card-balance-primary .change.positive { color: var(--positive-color); }
        .finance-card .card-balance-primary .change.negative { color: var(--negative-color); }
        .finance-card .card-balance-primary .change.neutral { color: var(--text-secondary-color); } /* Added for consistency */


        .finance-card .card-label-primary {
            display: block;
            font-size: 0.8em;
            color: var(--text-secondary-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .finance-card .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: flex-end; /* Align items to the bottom */
        }

        .finance-card .card-info-secondary {
            text-align: left;
        }

        .finance-card .card-info-secondary .label {
            display: block;
            font-size: 0.75em;
            color: var(--text-secondary-color);
            text-transform: uppercase;
            margin-bottom: 2px;
            letter-spacing: 0.5px;
        }

        .finance-card .card-info-secondary #totalInvestment {
            font-size: 1.1em; /* Slightly larger than labels */
            font-weight: 500;
        }

        /* Simple decorative chip */
        .finance-card .card-chip {
            width: 38px;
            height: 28px;
            background-color: #888; /* Silver/grey color */
            border-radius: 4px;
            background: linear-gradient(135deg, #a0a0a0, #707070); /* Subtle gradient for chip */
        }
        /* --- END: Finance Card Styles --- */

    </style>
</head>
<body>
    <div class="container">
         <header>
             <div class="header-main">
                 <h1>Billetera</h1>
                 <p>Stock Market Tracker</p>
             </div>
             <div class="header-actions">
                 <button id="removeTransactionBtn">Remover</button>
                 <button id="addTransactionBtn">Añadir</button>
             </div>
         </header>

         <!-- START: New Finance Card Section -->
         <div class="finance-card">
             <div class="card-header">
                 <div class="card-logo"></div> <!-- Mastercard-like logo -->
                 <div class="card-wallet-icon">
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="28px" height="28px">
                         <path d="M18 4H6C4.9 4 4 4.9 4 6v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H6V6h12v12zm-7-8H8v2h3v-2zm5 0h-3v2h3v-2z"/> <!-- Simple wallet icon -->
                     </svg>
                 </div>
             </div>
             <div class="card-body">
                 <div class="card-balance-primary">
                     <span id="totalCapitalization">$0.00</span> <!-- Main figure: Capitalization -->
                     <span class="change" id="capitalizationChange"></span>
                 </div>
                 <span class="card-label-primary">Capitalización Actual</span>
             </div>
             <div class="card-footer">
                 <div class="card-info-secondary">
                     <span class="label">Inversión Total</span>
                     <span id="totalInvestment">$0.00</span> <!-- Secondary figure: Investment -->
                 </div>
                 <div class="card-chip"></div> <!-- Decorative Chip -->
             </div>
         </div>
         <!-- END: New Finance Card Section -->

         <div class="currency-selector-container">
             <label>Divisa</label>
             <select id="currencySelector">
                 <option value="USD">USD</option>
                 <option value="GTQ">GTQ</option>
             </select>
         </div>

         <main class="chart-area">
             <canvas id="stockChart"></canvas>
         </main>

         <section class="transaction-list" id="transactionListContainer">
             <p class="no-transactions">Desliza transacciones para eliminar/editar.</p>
         </section>

         <footer>
             <p>Datos Históricos</p>
         </footer>

         <div id="addTransactionModal" class="modal">
             <div class="modal-content">
                 <span class="close-button" id="closeModalBtn">×</span>
                 <h2 id="modalTitle">Añadir Nueva Transacción</h2>
                 <form id="addTransactionForm">
                     <input type="hidden" id="editTransactionId" name="editTransactionId">
                     <label for="ticker">Ticker:</label>
                     <input type="text" id="ticker" name="ticker" required maxlength="10">
                     <label for="assetType">Tipo de Activo:</label>
                     <input type="text" id="assetType" name="assetType" placeholder="Ej: Acción, ETF, Fondo" required>
                     <label for="purchasePrice">Precio de Compra (por acción, en USD):</label>
                     <input type="number" id="purchasePrice" name="purchasePrice" step="0.01" min="0" required>
                     <label for="shares">Acciones:</label>
                     <input type="number" id="shares" name="shares" step="any" min="0" required>
                     <label for="salePrice">Precio de Venta (por acción, en USD, opcional):</label>
                     <input type="number" id="salePrice" name="salePrice" step="0.01" min="0">
                     <label for="transactionDateTime">Fecha/Hora Transacción:</label>
                     <input type="datetime-local" id="transactionDateTime" name="transactionDateTime" required>
                     <small style="display: block; margin-top: -10px; margin-bottom: 15px; color: var(--text-secondary-color);">Fecha/hora de la compra</small>
                     <div class="modal-actions">
                         <button type="button" id="cancelModalBtn">Cancelar</button>
                         <button type="submit" class="primary" id="modalSubmitBtn">Añadir Transacción</button>
                     </div>
                 </form>
             </div>
         </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const addTransactionBtn = document.getElementById('addTransactionBtn');
            const removeTransactionBtn = document.getElementById('removeTransactionBtn');
            const modal = document.getElementById('addTransactionModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const cancelModalBtn = document.getElementById('cancelModalBtn');
            const addTransactionForm = document.getElementById('addTransactionForm');
            const transactionListContainer = document.getElementById('transactionListContainer');
            const totalInvestmentEl = document.getElementById('totalInvestment');
            const totalCapitalizationEl = document.getElementById('totalCapitalization');
            const capitalizationChangeEl = document.getElementById('capitalizationChange');
            const currencySelector = document.getElementById('currencySelector');
            const chartCanvas = document.getElementById('stockChart');
            const modalTitle = document.getElementById('modalTitle');
            const modalSubmitBtn = document.getElementById('modalSubmitBtn');
            const editTransactionIdInput = document.getElementById('editTransactionId');

            let transactions = [];
            let currentCurrency = 'USD';
            let exchangeRates = { USD: 1, GTQ: 7.8 };
            let stockChart = null;
            let dragStartX = 0;
            let currentDragX = 0;
            let draggedItemElement = null;
            let draggedItemWrapper = null;
            let isDragging = false;
            let editingItemId = null;
            const swipeThreshold = 75;
            const dragStartThreshold = 5;

            const EXCHANGE_RATE_API_URL = 'https://api.exchangerate-api.com/v4/latest/USD';
            const CACHE_DURATION_MS = 60 * 60 * 1000; // 1 hour cache

            // --- Helper Functions ---
            function formatShares(value) { return Number(value.toFixed(4)); }
            function formatPercentage(value) {
                if (isNaN(value) || !isFinite(value)) return '';
                const sign = value >= 0 ? '+' : '';
                return `${sign}${value.toFixed(2)}%`;
            }
            function getTransactionResultUSD(tx) {
                return (tx.salePrice !== null && !isNaN(tx.salePrice)) ? (tx.salePrice * tx.shares) - (tx.purchasePrice * tx.shares) : 0;
            }

            // --- Exchange Rate Handling ---
            async function fetchExchangeRates() {
                const lastFetchTime = localStorage.getItem('exchangeRateFetchTime');
                const cachedRates = localStorage.getItem('exchangeRates');

                if (cachedRates && lastFetchTime && (Date.now() - parseInt(lastFetchTime)) < CACHE_DURATION_MS) {
                    try {
                        exchangeRates = JSON.parse(cachedRates);
                        console.log("Using cached exchange rates:", exchangeRates);
                        return exchangeRates;
                    } catch (e) {
                        console.error("Error parsing cached rates:", e);
                        localStorage.removeItem('exchangeRates');
                        localStorage.removeItem('exchangeRateFetchTime');
                    }
                }

                console.log("Fetching fresh exchange rates...");
                try {
                    const response = await fetch(EXCHANGE_RATE_API_URL);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();

                    if (data && data.rates && data.rates.GTQ) {
                        exchangeRates = { USD: 1, GTQ: data.rates.GTQ };
                        localStorage.setItem('exchangeRates', JSON.stringify(exchangeRates));
                        localStorage.setItem('exchangeRateFetchTime', Date.now().toString());
                        console.log("Fetched and cached new rates:", exchangeRates);
                        return exchangeRates;
                    } else {
                        throw new Error("Invalid API response format");
                    }
                } catch (error) {
                    console.error("Failed to fetch exchange rates:", error);
                    // Fallback to cached rates if fetch fails but cache exists
                    if (cachedRates) {
                        try {
                            exchangeRates = JSON.parse(cachedRates);
                            console.warn("Using stale cached rates due to fetch error:", exchangeRates);
                            return exchangeRates;
                        } catch(e) {
                            console.error("Error parsing stale cached rates:", e);
                        }
                    }
                    // If no cache and fetch fails, use default and alert user
                    exchangeRates = { USD: 1, GTQ: 7.8 }; // Reset to default
                    alert("No se pudieron obtener las tasas de cambio actuales. Usando valores por defecto (1 USD = 7.8 GTQ).");
                    return exchangeRates;
                }
            }

            function convertValue(valueInUSD, targetCurrency) {
                if (isNaN(valueInUSD) || valueInUSD === null) return 0;
                const rate = exchangeRates[targetCurrency] || 1;
                return valueInUSD * rate;
            }

            function formatCurrency(valueInUSD) {
                const convertedValue = convertValue(valueInUSD, currentCurrency);
                const symbol = currentCurrency === 'GTQ' ? 'Q' : '$';

                if (isNaN(convertedValue)) {
                    console.warn("formatCurrency received NaN for valueInUSD:", valueInUSD);
                    return `${symbol}0.00`;
                }

                const isNegative = valueInUSD < -0.0001; // Use small tolerance for floating point
                const absoluteFormattedValue = Math.abs(convertedValue).toFixed(2);
                return isNegative ? `-${symbol}${absoluteFormattedValue}` : `${symbol}${absoluteFormattedValue}`;
            }

             function formatChartAxisValue(valueInUSD) {
                const convertedValue = convertValue(valueInUSD, currentCurrency);
                if (isNaN(convertedValue)) return '0';
                // Show more precision for smaller values
                return convertedValue.toFixed(Math.abs(convertedValue) >= 10 || Math.abs(convertedValue) < 0.01 ? 0 : 2);
             }


            // --- Transaction Data Handling ---
            function loadTransactions() {
                 const storedTransactions = localStorage.getItem('stockTransactions');
                 if (storedTransactions) {
                     try {
                         transactions = JSON.parse(storedTransactions);
                         // Ensure data types are correct after parsing
                         transactions.forEach(tx => {
                             tx.dateTime = new Date(tx.dateTime); // Convert string back to Date object
                             tx.purchasePrice = parseFloat(tx.purchasePrice);
                             tx.shares = parseFloat(tx.shares);
                             tx.salePrice = tx.salePrice !== null && tx.salePrice !== undefined ? parseFloat(tx.salePrice) : null;
                             // Assign ID if missing (for older data)
                             if (!tx.id) tx.id = tx.dateTime.getTime().toString() + Math.random().toString(16).slice(2);
                         });
                         transactions.sort((a, b) => a.dateTime - b.dateTime); // Sort by date
                     } catch (e) {
                         console.error("Error parsing transactions from localStorage:", e);
                         transactions = [];
                         localStorage.removeItem('stockTransactions'); // Clear corrupted data
                     }
                 } else {
                     transactions = [];
                 }
             }
            function saveTransactions() {
                 transactions.sort((a, b) => a.dateTime - b.dateTime); // Ensure sorted before saving
                 localStorage.setItem('stockTransactions', JSON.stringify(transactions));
            }
            function findTransactionById(id) {
                return transactions.find(tx => tx.id === id);
            }
            function deleteTransaction(id) {
                const index = transactions.findIndex(tx => tx.id === id);
                if (index > -1) {
                    transactions.splice(index, 1);
                    saveTransactions();
                    updateUI(); // Update display after deletion
                } else {
                    console.warn("Tried to delete non-existent transaction ID:", id);
                }
            }

            // --- Chart Handling ---
            function initializeChart() {
                if (stockChart) {
                    stockChart.destroy(); // Ensure previous chart is destroyed
                }
                const ctx = chartCanvas.getContext('2d');
                const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-grid-color-val').trim();
                const tickColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-tick-color-val').trim();
                const lineBorderColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-line-color-val').trim();

                // Gradient for the area fill
                const gradient = ctx.createLinearGradient(0, 0, 0, 180); // Adjust height as needed
                gradient.addColorStop(0, 'rgba(38, 166, 154, 0.55)');   // Semi-transparent positive color start
                gradient.addColorStop(0.8, 'rgba(38, 166, 154, 0.05)'); // Fading out
                gradient.addColorStop(1, 'rgba(38, 166, 154, 0.0)');    // Fully transparent end

                stockChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [], // Populated by updateChart
                        datasets: [{
                            label: `Resultado (${currentCurrency})`, // Dynamic label
                            data: [], // Populated by updateChart
                            borderColor: lineBorderColor,
                            borderWidth: 2,
                            pointRadius: 0, // Hide points by default
                            pointHoverRadius: 5,
                            pointHitRadius: 10,
                            tension: 0.3, // Slightly curved lines
                            fill: true, // Enable area fill
                            backgroundColor: gradient // Apply the gradient
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false, // Allow negative values to scale properly
                                position: 'right', // Y-axis on the right
                                grid: {
                                    color: gridColor,
                                    drawBorder: false, // Hide the axis border line
                                },
                                ticks: {
                                    color: tickColor,
                                    padding: 10,
                                    maxTicksLimit: 5, // Limit number of ticks for clarity
                                    callback: function(value) {
                                        // 'value' here is the internal chart value (USD)
                                        return formatChartAxisValue(value);
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    display: false, // Hide vertical grid lines
                                    drawBorder: false,
                                },
                                ticks: {
                                    color: tickColor,
                                    padding: 10,
                                    maxRotation: 0, // Keep labels horizontal
                                    autoSkip: true, // Automatically skip labels if too crowded
                                    maxTicksLimit: 7, // Max number of date labels
                                    callback: function(value) {
                                        // 'value' is the index, use getLabelForValue to get the actual label (ISO string)
                                        const date = new Date(this.getLabelForValue(value));
                                        // Format date simply (e.g., "10", "2", "2") representing relevant points
                                        // You might want a more sophisticated formatter (e.g., 'MMM DD', 'HH:mm')
                                        // depending on the time scale of your transactions
                                        return date.toLocaleTimeString([], { hour: 'numeric', minute:'2-digit', hour12: true }).split(' ')[0]; // Just the hour like '10' or '2'
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false // Hide the legend box
                            },
                            tooltip: {
                                enabled: true,
                                mode: 'index', // Show tooltip for all items at that index
                                intersect: false, // Tooltip appears even when not hovering directly over point
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                titleFont: { size: 14 },
                                bodyFont: { size: 12 },
                                padding: 10,
                                displayColors: false, // Hide the color box in tooltip
                                callbacks: {
                                    label: function(context) {
                                        // context.parsed.y holds the data value (USD)
                                        return `Resultado: ${formatCurrency(context.parsed.y)}`;
                                    },
                                    title: function(tooltipItems) {
                                        // tooltipItems[0].label holds the original label (ISO date string)
                                        const date = new Date(tooltipItems[0].label);
                                        return date.toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short'}); // Format date nicely
                                    }
                                }
                            }
                        },
                        interaction: {
                            mode: 'index', // Interaction applies to the whole vertical index
                            axis: 'x',
                            intersect: false // Interaction triggers without direct hover on point
                        }
                    }
                });
            }

            function updateChart() {
                if (!stockChart) initializeChart(); // Ensure chart exists
                if (!stockChart) return; // Still no chart? Bail out.

                // Calculate cumulative results for the chart
                let cumulativeResultUSD = 0;
                const chartData = transactions.map(tx => {
                    cumulativeResultUSD += getTransactionResultUSD(tx);
                    return {
                        x: tx.dateTime.toISOString(), // Use ISO string for labels/parsing
                        y: cumulativeResultUSD          // Use cumulative result for Y value
                    };
                });

                // If there's only one transaction, add a dummy starting point at 0
                if (chartData.length === 1) {
                   const firstTxTime = new Date(transactions[0].dateTime);
                   const startTime = new Date(firstTxTime.getTime() - 60000); // 1 minute before first tx
                   chartData.unshift({ x: startTime.toISOString(), y: 0 });
                } else if (chartData.length === 0) {
                   // Add a dummy point at 0 if no data to show an empty chart baseline
                   const now = new Date();
                   const startTime = new Date(now.getTime() - 60000);
                   chartData.push({ x: startTime.toISOString(), y: 0 });
                }


                stockChart.data.labels = chartData.map(d => d.x);
                stockChart.data.datasets[0].data = chartData.map(d => d.y);
                stockChart.data.datasets[0].label = `Resultado Acumulado (${currentCurrency})`; // Update label with currency

                // Update dynamic options based on currency/theme if needed
                stockChart.options.scales.y.ticks.color = getComputedStyle(document.documentElement).getPropertyValue('--chart-tick-color-val').trim();
                stockChart.options.scales.y.grid.color = getComputedStyle(document.documentElement).getPropertyValue('--chart-grid-color-val').trim();
                stockChart.options.scales.x.ticks.color = getComputedStyle(document.documentElement).getPropertyValue('--chart-tick-color-val').trim();
                stockChart.data.datasets[0].borderColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-line-color-val').trim();

                // Re-assign callback to ensure it uses the latest currentCurrency
                stockChart.options.scales.y.ticks.callback = function(value) {
                    return formatChartAxisValue(value);
                };
                stockChart.options.plugins.tooltip.callbacks.label = function(context) {
                    return `Resultado: ${formatCurrency(context.parsed.y)}`;
                };


                stockChart.update(); // Refresh the chart
            }


            // --- Swipe Handling ---
            function handleDragStart(event) {
                if (event.type === 'mousedown' && event.button !== 0) return; // Only left clicks

                const targetItem = event.target.closest('.transaction-item');
                if (!targetItem) return; // Didn't click on a draggable item

                draggedItemElement = targetItem;
                draggedItemWrapper = targetItem.closest('.transaction-item-wrapper');
                if (!draggedItemWrapper) return; // Should always have a wrapper

                dragStartX = event.touches ? event.touches[0].clientX : event.clientX;
                currentDragX = dragStartX; // Initialize current position
                isDragging = false; // Not dragging yet, need to pass threshold

                // Prevent text selection during drag
                document.body.style.userSelect = 'none';
             }

            function handleDragMove(event) {
                if (!draggedItemElement) return;

                // Prevent vertical scroll while swiping horizontally
                if (event.touches && event.cancelable) {
                    event.preventDefault();
                }

                currentDragX = event.touches ? event.touches[0].clientX : event.clientX;
                const diffX = currentDragX - dragStartX;

                // Only start visual drag after exceeding threshold
                if (!isDragging && Math.abs(diffX) > dragStartThreshold) {
                    isDragging = true;
                    draggedItemElement.classList.add('dragging');
                    draggedItemElement.style.transition = 'none'; // Disable transition during drag for smoothness
                }

                if (isDragging) {
                    draggedItemElement.style.transform = `translateX(${diffX}px)`;

                    // Update background visibility and content
                    const background = draggedItemWrapper.querySelector('.transaction-item-swipe-background');
                    if (background) {
                        const swipeRatio = Math.min(1, Math.abs(diffX) / (swipeThreshold * 1.5)); // Make it fully visible a bit after threshold
                        background.style.opacity = swipeRatio;

                        if (diffX > dragStartThreshold) { // Swiping right (Edit)
                            background.className = 'transaction-item-swipe-background swipe-edit';
                            background.innerHTML = `<span>EDITAR</span><span></span>`;
                        } else if (diffX < -dragStartThreshold) { // Swiping left (Delete)
                            background.className = 'transaction-item-swipe-background swipe-delete';
                            background.innerHTML = `<span></span><span>ELIMINAR</span>`;
                        } else {
                            background.style.opacity = 0; // Hide if back near center
                        }
                    }
                }
             }

            function handleDragEnd(event) {
                if (!isDragging) { // If drag didn't actually start (didn't pass threshold)
                    resetDragState();
                    return;
                }

                const diffX = currentDragX - dragStartX;
                const transactionId = draggedItemWrapper.dataset.id;

                if (!transactionId) {
                    console.error("Missing transaction ID on dragged item wrapper.");
                    snapBack(draggedItemElement); // Snap back if ID is missing
                    resetDragState();
                    return;
                }

                // Re-enable transition for snap/slide effects
                 if (draggedItemElement) {
                    draggedItemElement.style.transition = 'transform 0.1s ease-out';
                 }


                if (diffX > swipeThreshold) { // Swiped right enough for Edit
                    console.log("Edit action triggered for ID:", transactionId);
                    editingItemId = transactionId; // Track which item is being edited
                    openEditModal(transactionId);
                    // Don't snap back immediately, modal opens, snap handled in closeModal or if edit cancelled
                } else if (diffX < -swipeThreshold) { // Swiped left enough for Delete
                    console.log("Delete action triggered for ID:", transactionId);
                    // Use custom confirmation if available, otherwise browser default
                    if (confirm(`¿Seguro que quieres eliminar esta transacción (${findTransactionById(transactionId)?.ticker || 'N/A'})?`)) {
                        // Animate out before deleting data
                        if (draggedItemWrapper) {
                            draggedItemWrapper.style.transition = 'height 0.2s ease-out, opacity 0.2s ease-out, margin 0.2s ease-out';
                            draggedItemWrapper.style.height = '0px';
                            draggedItemWrapper.style.opacity = '0';
                            draggedItemWrapper.style.marginBottom = '0px'; // Collapse margin too
                            draggedItemWrapper.style.paddingTop = '0px';
                            draggedItemWrapper.style.paddingBottom = '0px';


                            // Wait for animation to finish before removing from DOM/data
                            setTimeout(() => {
                                deleteTransaction(transactionId);
                                // updateUI() is called within deleteTransaction
                            }, 200); // Match timeout to CSS transition duration
                        } else {
                            deleteTransaction(transactionId); // Fallback if wrapper somehow lost
                        }
                    } else {
                        snapBack(draggedItemElement); // Snap back if deletion cancelled
                    }
                } else {
                    // Didn't swipe far enough, snap back
                    snapBack(draggedItemElement);
                }

                resetDragState();
            }

             function resetDragState() {
                 if (draggedItemElement) {
                     draggedItemElement.classList.remove('dragging');
                     // Ensure transition is reset if it wasn't already during snapBack/animation
                     draggedItemElement.style.transition = 'transform 0.1s ease-out';
                 }
                 isDragging = false;
                 draggedItemElement = null;
                 // Keep draggedItemWrapper temporarily if edit modal is open, otherwise clear
                 if (!editingItemId) {
                     draggedItemWrapper = null;
                 }
                 dragStartX = 0;
                 currentDragX = 0;
                 document.body.style.userSelect = ''; // Re-enable text selection
             }

             function snapBack(item) {
                 if (!item) return;
                 item.style.transform = 'translateX(0px)';
                 const wrapper = item.closest('.transaction-item-wrapper');
                 if (wrapper) {
                     const background = wrapper.querySelector('.transaction-item-swipe-background');
                     if (background) {
                         // Fade out the background quickly
                         background.style.transition = 'opacity 0.1s ease-out';
                         background.style.opacity = 0;
                     }
                 }
             }

             function attachSwipeListeners(wrapperElement) {
                 // Use passive: true where possible, but move needs false to allow preventDefault
                 wrapperElement.addEventListener('touchstart', handleDragStart, { passive: true });
                 wrapperElement.addEventListener('touchmove', handleDragMove, { passive: false }); // Need false to prevent scroll
                 wrapperElement.addEventListener('touchend', handleDragEnd);
                 wrapperElement.addEventListener('touchcancel', handleDragEnd); // Handle cancelled touches

                 // Mouse events for desktop
                 wrapperElement.addEventListener('mousedown', handleDragStart);
                 // Add mousemove/mouseup listeners to the document to capture drags
                 // that move off the original element. These are added here but managed
                 // in the handlers themselves (only active while dragging).
             }
             // Add global listeners for mouseup/mousemove to handle dragging ending anywhere
             document.addEventListener('mousemove', (e) => {
                 // Only call handler if dragging actually started
                 if(isDragging) { handleDragMove(e); }
             });
             document.addEventListener('mouseup', (e) => {
                 // Only call handler if dragging actually started
                 if(isDragging) { handleDragEnd(e); }
             });


            // --- Modal Handling ---
             function openAddModal() {
                 modalTitle.textContent = "Añadir Nueva Transacción";
                 modalSubmitBtn.textContent = "Añadir";
                 addTransactionForm.reset(); // Clear previous input
                 editTransactionIdInput.value = ''; // Ensure no edit ID is set
                 editingItemId = null; // Clear editing state

                 // Pre-fill date/time to current time
                 const now = new Date();
                 now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); // Adjust for local timezone
                 document.getElementById('transactionDateTime').value = now.toISOString().slice(0, 16);

                 modal.style.display = 'flex'; // Show modal
                 document.getElementById('ticker').focus(); // Focus first field
             }

             function openEditModal(transactionId) {
                 const tx = findTransactionById(transactionId);
                 if (!tx) {
                    console.error("Cannot open edit modal: Transaction not found for ID", transactionId);
                    snapBack(draggedItemElement); // Snap back the item if tx data is missing
                    resetDragState();
                    return;
                 }

                 modalTitle.textContent = "Editar Transacción";
                 modalSubmitBtn.textContent = "Actualizar";
                 addTransactionForm.reset(); // Clear previous input first
                 editTransactionIdInput.value = tx.id; // Set the hidden ID field
                 editingItemId = tx.id; // Keep track of the item being edited

                 // Populate form fields with existing transaction data
                 document.getElementById('ticker').value = tx.ticker;
                 document.getElementById('assetType').value = tx.assetType;
                 document.getElementById('purchasePrice').value = tx.purchasePrice;
                 document.getElementById('shares').value = tx.shares;
                 document.getElementById('salePrice').value = tx.salePrice ?? ''; // Use nullish coalescing for optional field

                 // Format date correctly for datetime-local input
                 const localDateTime = new Date(tx.dateTime.getTime() - (tx.dateTime.getTimezoneOffset() * 60000))
                     .toISOString().slice(0, 16);
                 document.getElementById('transactionDateTime').value = localDateTime;

                 modal.style.display = 'flex'; // Show modal
                 document.getElementById('ticker').focus(); // Focus first field
             }

             function closeModal() {
                 modal.style.display = 'none';
                 // If an item was being edited, snap it back now that the modal is closed
                 if (editingItemId) {
                     const wrapperToSnap = transactionListContainer.querySelector(`.transaction-item-wrapper[data-id="${editingItemId}"]`);
                     if (wrapperToSnap) {
                         const itemToSnap = wrapperToSnap.querySelector('.transaction-item');
                         if (itemToSnap) {
                             snapBack(itemToSnap);
                         }
                     }
                 }
                 editingItemId = null; // Clear editing state
                 draggedItemWrapper = null; // Clear reference to wrapper
             }


            // --- UI Update Function ---
            function updateUI() {
                // Clear current list
                transactionListContainer.innerHTML = '';

                // Calculate Totals & Percentage
                let totalInvestmentUSD = 0;
                let totalCapitalizationUSD = 0; // Based on sale price if sold, otherwise purchase price? * Needs clarification *
                                               // Current logic uses ONLY sale price for capitalization

                transactions.forEach(tx => {
                    totalInvestmentUSD += (tx.purchasePrice * tx.shares);
                    // Capitalization = value of sold items
                    if (tx.salePrice !== null && !isNaN(tx.salePrice)) {
                        totalCapitalizationUSD += (tx.salePrice * tx.shares);
                    }
                    // If you want capitalization to reflect current value of UNSOLD items,
                    // you'd need a way to fetch current prices. For now, it's based on completed sales.
                });

                // Display Totals
                totalInvestmentEl.textContent = formatCurrency(totalInvestmentUSD);
                totalCapitalizationEl.textContent = formatCurrency(totalCapitalizationUSD);

                // Calculate and Display Percentage Change (Profit/Loss on Sold Items vs. Total Investment)
                let profitLossUSD = totalCapitalizationUSD - totalInvestmentUSD; // This is potentially misleading if items are unsold
                                                                                  // A better metric might be P/L only on SOLD items vs their cost.
                                                                                  // Let's recalculate based *only* on sold items
                let costOfSoldItemsUSD = 0;
                let revenueFromSoldItemsUSD = 0;
                transactions.forEach(tx => {
                    if (tx.salePrice !== null && !isNaN(tx.salePrice)) {
                        costOfSoldItemsUSD += (tx.purchasePrice * tx.shares);
                        revenueFromSoldItemsUSD += (tx.salePrice * tx.shares);
                    }
                });

                let profitLossOnSoldUSD = revenueFromSoldItemsUSD - costOfSoldItemsUSD;
                let percentageChange = costOfSoldItemsUSD !== 0 ? (profitLossOnSoldUSD / costOfSoldItemsUSD) * 100 : 0;


                // Display Percentage Change
                capitalizationChangeEl.textContent = formatPercentage(percentageChange);
                capitalizationChangeEl.className = 'change'; // Reset classes
                if (percentageChange > 0.01) { // Use a small threshold for floating point
                    capitalizationChangeEl.classList.add('positive');
                } else if (percentageChange < -0.01) {
                    capitalizationChangeEl.classList.add('negative');
                } else {
                     capitalizationChangeEl.classList.add('neutral');
                }

                // Display Transactions List (Most Recent First)
                const displayTransactions = [...transactions].reverse(); // Create reversed copy for display

                if (transactions.length === 0) {
                    transactionListContainer.innerHTML = '<p class="no-transactions">Añade tu primera transacción o desliza para editar/eliminar.</p>';
                } else {
                    displayTransactions.forEach(tx => {
                        const resultUSD = getTransactionResultUSD(tx); // P/L for this specific transaction if sold
                        let resultClass = 'neutral';
                        if (resultUSD > 0.001) resultClass = 'positive';
                        else if (resultUSD < -0.001) resultClass = 'negative';

                        const wrapper = document.createElement('div');
                        wrapper.classList.add('transaction-item-wrapper');
                        wrapper.dataset.id = tx.id; // Add ID for swipe actions

                        // Background for swipe actions (initially hidden)
                        const swipeBg = document.createElement('div');
                        swipeBg.className = 'transaction-item-swipe-background';
                        swipeBg.style.opacity = 0;
                        wrapper.appendChild(swipeBg);

                        // Visible transaction item content
                        const item = document.createElement('div');
                        item.classList.add('transaction-item');
                        // Display Ticker, Result (if sold), Shares label, Shares value
                        item.innerHTML = `
                            <span>${tx.ticker.toUpperCase()}</span>
                            <span class="result ${resultClass}">${tx.salePrice !== null ? formatCurrency(resultUSD) : ''}</span>
                            <span style="color: var(--text-secondary-color); font-size: 0.85em;">${tx.assetType || 'Activo'}</span>
                            <span>${formatShares(tx.shares)}</span>
                        `;
                        // Adjust grid template based on whether result is shown
                        if (tx.salePrice !== null) {
                             item.style.gridTemplateColumns = "auto 1fr auto auto";
                        } else {
                             item.style.gridTemplateColumns = "auto 1fr auto"; // Adjust if no result shown
                             item.children[1].textContent = ''; // Clear the result span visually
                             item.children[1].style.display = 'none'; // Hide result span
                             item.children[2].style.textAlign = 'right'; // Align asset type right
                             item.children[3].style.textAlign = 'right'; // Align shares right
                        }


                        wrapper.appendChild(item);
                        transactionListContainer.appendChild(wrapper);

                        // Attach swipe listeners to the wrapper AFTER it's in the DOM
                        attachSwipeListeners(wrapper);
                    });
                }

                // Update Chart
                updateChart();
            }


            // --- Event Listeners ---
            addTransactionBtn.addEventListener('click', openAddModal);

            removeTransactionBtn.addEventListener('click', () => {
                if (transactions.length === 0) {
                    alert("No hay transacciones para eliminar.");
                    return;
                }
                if (confirm("¿Seguro que quieres eliminar TODAS las transacciones? Esta acción no se puede deshacer.")) {
                    transactions = [];
                    saveTransactions();
                    updateUI();
                }
            });

            closeModalBtn.addEventListener('click', closeModal);
            cancelModalBtn.addEventListener('click', closeModal);

            // Close modal if clicking outside the content area
            window.addEventListener('click', (event) => {
                if (event.target === modal) {
                    closeModal();
                }
            });

            addTransactionForm.addEventListener('submit', (event) => {
                event.preventDefault(); // Prevent default form submission

                const formData = new FormData(event.target);
                const editId = formData.get('editTransactionId');

                // Basic validation
                const ticker = formData.get('ticker')?.trim().toUpperCase();
                const assetType = formData.get('assetType')?.trim();
                const purchasePriceStr = formData.get('purchasePrice');
                const sharesStr = formData.get('shares');
                const salePriceStr = formData.get('salePrice');
                const dateTimeStr = formData.get('transactionDateTime');

                if (!ticker || !assetType || !purchasePriceStr || !sharesStr || !dateTimeStr) {
                     alert("Por favor, rellena todos los campos obligatorios (Ticker, Tipo, Precio Compra, Acciones, Fecha).");
                     return;
                }


                const transactionData = {
                    ticker: ticker,
                    assetType: assetType,
                    purchasePrice: parseFloat(purchasePriceStr),
                    shares: parseFloat(sharesStr),
                    // Handle optional sale price: convert to number if present, else null
                    salePrice: (salePriceStr && !isNaN(parseFloat(salePriceStr))) ? parseFloat(salePriceStr) : null,
                    dateTime: new Date(dateTimeStr) // Parse date string
                };

                // More robust validation for numbers and date
                if (isNaN(transactionData.purchasePrice) || transactionData.purchasePrice < 0 ||
                    isNaN(transactionData.shares) || transactionData.shares <= 0 || // Shares should be > 0
                    (transactionData.salePrice !== null && (isNaN(transactionData.salePrice) || transactionData.salePrice < 0)) ||
                    isNaN(transactionData.dateTime.getTime())) { // Check if date is valid
                    alert("Por favor, introduce valores numéricos válidos y una fecha correcta.");
                    return;
                }


                if (editId) {
                    // Editing existing transaction
                    const index = transactions.findIndex(tx => tx.id === editId);
                    if (index > -1) {
                        // Preserve the original ID when updating
                        transactions[index] = { ...transactions[index], ...transactionData };
                        console.log("Transaction updated:", transactions[index]);
                    } else {
                        console.error("Transaction ID not found for editing:", editId);
                        alert("Error: No se pudo encontrar la transacción para actualizar.");
                        closeModal(); // Close modal even on error
                        return;
                    }
                } else {
                    // Adding new transaction
                    transactionData.id = Date.now().toString() + Math.random().toString(16).slice(2); // Generate unique ID
                    transactions.push(transactionData);
                    console.log("Transaction added:", transactionData);
                }

                saveTransactions();
                updateUI();
                closeModal();
            });

            currencySelector.addEventListener('change', async (event) => {
                currentCurrency = event.target.value;
                localStorage.setItem('selectedCurrency', currentCurrency);
                await fetchExchangeRates(); // Re-fetch or use cache
                updateUI(); // Update display with new currency
            });

            // --- Initialization ---
            async function initializeApp() {
                currentCurrency = localStorage.getItem('selectedCurrency') || 'USD';
                currencySelector.value = currentCurrency;

                loadTransactions(); // Load data first
                initializeChart(); // Setup chart structure
                await fetchExchangeRates(); // Get rates needed for display
                updateUI(); // Populate UI and chart with data and correct currency
            }

            initializeApp();

        }); // End DOMContentLoaded
    </script>
</body>
</html>
