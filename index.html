<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Market Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --text-color: #e0e0e0;
            --text-secondary-color: #a0a0a0;
            --positive-color: #26a69a;
            --negative-color: #ef5350;
            --neutral-color: var(--text-secondary-color);
            --border-color: #444;
            --button-bg: #333;
            --button-hover-bg: #444;
            --chart-grid-color-val: rgba(255, 255, 255, 0.1);
            --chart-line-color-val: #26a69a;
            --chart-tick-color-val: #a0a0a0;
            --font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            --modal-bg: rgba(0, 0, 0, 0.7);
            --modal-content-bg: #2a2a2a;
            --swipe-delete-bg: var(--negative-color);
            --swipe-edit-bg: var(--positive-color);
            --link-color: #42a5f5;
            --card-skin-1-bg: url('assets/gradient_type_v01.png');
            --card-skin-2-bg: url('assets/gradient_type_v02.png');
            --card-skin-default-bg: linear-gradient(160deg, #404040, #2d2d2d);
            --card-glass-effect-bg: rgba(45, 45, 45, 0.6);
            --card-glass-border: rgba(255, 255, 255, 0.1);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-family);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
            font-size: 14px;
        }
        .container {
            max-width: 400px;
            width: 100%;
            overflow: hidden;
        }
        header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .header-main { flex-grow: 1; } .header-main h1 { font-size: 2.5em; font-weight: bold; line-height: 1; margin-bottom: 2px; } .header-main p { color: var(--text-secondary-color); font-size: 0.9em; }
        .header-actions { display: flex; align-items: center; flex-shrink: 0; }
        .header-actions button { background-color: var(--button-bg); color: var(--text-color); border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 0.85em; margin-left: 8px; transition: background-color 0.2s ease; white-space: nowrap; } .header-actions button:hover { background-color: var(--button-hover-bg); }

        .currency-selector-container { color: var(--text-secondary-color); font-size: 0.9em; margin-bottom: 20px; display: flex; align-items: center; } .currency-selector-container label { margin-right: 5px; }
        #currencySelector { background-color: var(--button-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 4px; padding: 2px 5px; font-size: 1em; cursor: pointer; -webkit-appearance: none; -moz-appearance: none; appearance: none; } #currencySelector:focus { outline: none; box-shadow: none; }
        .chart-area { height: 200px; margin-bottom: 25px; position: relative; }
        .transaction-list { margin-bottom: 20px; min-height: 80px; }
        .transaction-item-wrapper { position: relative; overflow: hidden; background-color: var(--modal-content-bg); user-select: none; touch-action: pan-y; border-bottom: 1px solid var(--border-color); } .transaction-item-wrapper:last-child { border-bottom: none;}
        .transaction-item-swipe-background { position: absolute; top: 0; bottom: 0; width: 100%; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; color: white; font-weight: bold; opacity: 0; transition: opacity 0.1s ease-out; } .swipe-delete { background-color: var(--swipe-delete-bg); justify-content: flex-end; } .swipe-edit { background-color: var(--swipe-edit-bg); justify-content: flex-start; }
        .transaction-item {
            display: grid;
            grid-template-columns: auto 1fr auto auto;
            gap: 10px;
            padding: 12px 10px;
            align-items: baseline;
            font-size: 0.95em;
            background-color: var(--modal-content-bg);
            position: relative;
            transition: transform 0.1s ease-out;
            cursor: grab;
        }
        .transaction-item.no-result {
            grid-template-columns: auto 1fr auto;
        }
        .transaction-item.no-result span:nth-child(2) {
             display: none;
        }
        .transaction-item.no-result span:nth-child(3) {
            text-align: right;
        }
        .transaction-item.dragging { cursor: grabbing; transition: none; }
        .transaction-item span:nth-child(1) { font-weight: 600; }
        .transaction-item span:nth-child(2) { text-align: right; font-weight: 600; }
        .transaction-item span.result.positive { color: var(--positive-color); }
        .transaction-item span.result.negative { color: var(--negative-color); }
        .transaction-item span.result.neutral { color: var(--neutral-color); }
        .transaction-item span:nth-child(3) { color: var(--text-secondary-color); font-size: 0.85em; }
        .transaction-item span:nth-child(4) { text-align: right; font-weight: 500; min-width: 50px; }
        .no-transactions { color: var(--text-secondary-color); text-align: center; padding: 20px 0; font-style: italic; }
        footer p { color: var(--link-color); font-size: 0.9em; display: block; text-align: left; margin-top: 10px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: var(--modal-bg); align-items: center; justify-content: center; } .modal-content { background-color: var(--modal-content-bg); margin: auto; padding: 25px; border: 1px solid var(--border-color); width: 80%; max-width: 450px; border-radius: 8px; color: var(--text-color); box-shadow: 0 5px 15px rgba(0,0,0,0.5); } .modal-content h2 { margin-top: 0; margin-bottom: 20px; font-weight: 500; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; } .modal-content label { display: block; margin-bottom: 5px; font-size: 0.9em; color: var(--text-secondary-color); } .modal-content input[type="text"], .modal-content input[type="number"], .modal-content input[type="datetime-local"], .modal-content select { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--button-bg); color: var(--text-color); font-size: 1em; } .modal-content input[type="number"]::-webkit-inner-spin-button, .modal-content input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; } .modal-content input[type="number"] { -moz-appearance: textfield; } .modal-actions { text-align: right; margin-top: 20px; } .modal-actions button { background-color: var(--button-bg); color: var(--text-color); border: none; padding: 10px 18px; border-radius: 5px; cursor: pointer; font-size: 0.9em; margin-left: 10px; transition: background-color 0.2s ease; } .modal-actions button.primary { background-color: var(--positive-color); color: #fff; } .modal-actions button.primary:hover { background-color: #1e8e84; } .modal-actions button:hover { background-color: var(--button-hover-bg); } .close-button { color: var(--text-secondary-color); float: right; font-size: 24px; font-weight: bold; line-height: 1; cursor: pointer; margin-top: -10px; } .close-button:hover, .close-button:focus { color: var(--text-color); text-decoration: none; }

        .finance-card {
            border-radius: 15px;
            padding: 20px;
            color: var(--text-color);
            position: relative;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            font-family: var(--font-family);
            cursor: grab;
            user-select: none;
            touch-action: pan-y;
            transition: background 0.5s ease-in-out;
            background-color: var(--card-glass-effect-bg);
            border: 1px solid var(--card-glass-border);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .finance-card.skin-default {
            background-image: var(--card-skin-default-bg);
            background-size: cover;
            background-position: center;
        }
        .finance-card.skin-1 {
            background-image: var(--card-skin-1-bg);
            background-size: cover;
            background-position: center;
        }
        .finance-card.skin-2 {
            background-image: var(--card-skin-2-bg);
            background-size: cover;
            background-position: center;
        }

        .finance-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .finance-card .card-logo {
            width: 45px;
            height: 28px;
            position: relative;
        }
        .finance-card .card-logo::before,
        .finance-card .card-logo::after {
            content: '';
            position: absolute;
            top: 0;
            width: 28px;
            height: 28px;
            border-radius: 50%;
        }
        .finance-card .card-logo::before {
            left: 0;
            background-color: rgba(255, 255, 255, 0.4);
            z-index: 1;
        }
        .finance-card .card-logo::after {
            left: 17px;
            background-color: rgba(255, 255, 255, 0.3);
            z-index: 2;
        }

        .finance-card .card-body {
            margin-bottom: 25px;
            text-align: left;
        }

        .finance-card .card-balance-primary {
            display: flex;
            align-items: baseline;
            margin-bottom: 4px;
        }

        .finance-card .card-balance-primary #totalCapitalization {
            font-size: 2.3em;
            font-weight: 500;
            line-height: 1.1;
            letter-spacing: 0.5px;
            margin-right: 8px;
        }

        .finance-card .card-balance-primary .change {
            font-size: 1em;
            font-weight: 500;
        }
        .finance-card .card-balance-primary .change.positive { color: var(--positive-color); }
        .finance-card .card-balance-primary .change.negative { color: var(--negative-color); }
        .finance-card .card-balance-primary .change.neutral { color: var(--text-secondary-color); }


        .finance-card .card-label-primary {
            display: block;
            font-size: 0.8em;
            color: var(--text-secondary-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .finance-card .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .finance-card .card-info-secondary {
            text-align: left;
        }

        .finance-card .card-info-secondary .label {
            display: block;
            font-size: 0.75em;
            color: var(--text-secondary-color);
            text-transform: uppercase;
            margin-bottom: 2px;
            letter-spacing: 0.5px;
        }

        .finance-card .card-info-secondary #totalInvestment {
            font-size: 1.1em;
            font-weight: 500;
        }

        @media (min-width: 600px) {
            body { font-size: 15px; }
            .header-main h1 { font-size: 2.8em; }
        }

         @media (min-width: 1024px) {
             body { font-size: 16px; padding: 30px; }
             .container { max-width: 450px; }
             .finance-card .card-balance-primary #totalCapitalization { font-size: 2.5em; }
        }

    </style>
</head>
<body>
    <div class="container">
         <header>
             <div class="header-main">
                 <h1>Billetera</h1>
                 <p>Stock Market Tracker</p>
             </div>
             <div class="header-actions">
                 <button id="removeTransactionBtn">Remover</button>
                 <button id="addTransactionBtn">Añadir</button>
             </div>
         </header>

         <div class="finance-card" id="financeCard">
             <div class="card-header">
                 <div class="card-logo"></div>
             </div>
             <div class="card-body">
                 <div class="card-balance-primary">
                     <span id="totalCapitalization">$0.00</span>
                     <span class="change" id="capitalizationChange"></span>
                 </div>
                 <span class="card-label-primary">Capitalización Actual</span>
             </div>
             <div class="card-footer">
                 <div class="card-info-secondary">
                     <span class="label">Inversión Total</span>
                     <span id="totalInvestment">$0.00</span>
                 </div>
             </div>
         </div>

         <div class="currency-selector-container">
             <label>Divisa</label>
             <select id="currencySelector">
                 <option value="USD">USD</option>
                 <option value="GTQ">GTQ</option>
             </select>
         </div>

         <main class="chart-area">
             <canvas id="stockChart"></canvas>
         </main>

         <section class="transaction-list" id="transactionListContainer">
             <p class="no-transactions">Desliza transacciones para eliminar/editar.</p>
         </section>

         <footer>
             <p>Datos Históricos</p>
         </footer>

         <div id="addTransactionModal" class="modal">
             <div class="modal-content">
                 <span class="close-button" id="closeModalBtn">×</span>
                 <h2 id="modalTitle">Añadir Nueva Transacción</h2>
                 <form id="addTransactionForm">
                     <input type="hidden" id="editTransactionId" name="editTransactionId">
                     <label for="ticker">Ticker:</label>
                     <input type="text" id="ticker" name="ticker" required maxlength="10">
                     <label for="assetType">Tipo de Activo:</label>
                     <input type="text" id="assetType" name="assetType" placeholder="Ej: Acción, ETF, Fondo" required>
                     <label for="purchasePrice">Precio de Compra (por acción, en USD):</label>
                     <input type="number" id="purchasePrice" name="purchasePrice" step="0.01" min="0" required>
                     <label for="shares">Acciones:</label>
                     <input type="number" id="shares" name="shares" step="any" min="0" required>
                     <label for="salePrice">Precio de Venta (por acción, en USD, opcional):</label>
                     <input type="number" id="salePrice" name="salePrice" step="0.01" min="0">
                     <label for="transactionDateTime">Fecha/Hora Transacción:</label>
                     <input type="datetime-local" id="transactionDateTime" name="transactionDateTime" required>
                     <small style="display: block; margin-top: -10px; margin-bottom: 15px; color: var(--text-secondary-color);">Fecha/hora de la compra</small>
                     <div class="modal-actions">
                         <button type="button" id="cancelModalBtn">Cancelar</button>
                         <button type="submit" class="primary" id="modalSubmitBtn">Añadir Transacción</button>
                     </div>
                 </form>
             </div>
         </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const addTransactionBtn = document.getElementById('addTransactionBtn');
            const removeTransactionBtn = document.getElementById('removeTransactionBtn');
            const modal = document.getElementById('addTransactionModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const cancelModalBtn = document.getElementById('cancelModalBtn');
            const addTransactionForm = document.getElementById('addTransactionForm');
            const transactionListContainer = document.getElementById('transactionListContainer');
            const totalInvestmentEl = document.getElementById('totalInvestment');
            const totalCapitalizationEl = document.getElementById('totalCapitalization');
            const capitalizationChangeEl = document.getElementById('capitalizationChange');
            const currencySelector = document.getElementById('currencySelector');
            const chartCanvas = document.getElementById('stockChart');
            const modalTitle = document.getElementById('modalTitle');
            const modalSubmitBtn = document.getElementById('modalSubmitBtn');
            const editTransactionIdInput = document.getElementById('editTransactionId');
            const financeCard = document.getElementById('financeCard');

            let transactions = [];
            let currentCurrency = 'USD';
            let exchangeRates = { USD: 1, GTQ: 7.8 };
            let stockChart = null;
            let dragStartX = 0;
            let currentDragX = 0;
            let draggedItemElement = null;
            let draggedItemWrapper = null;
            let isDragging = false;
            let editingItemId = null;
            const swipeThreshold = 75;
            const dragStartThreshold = 5;
            const cardSkins = ['skin-default', 'skin-1', 'skin-2'];
            let currentSkinIndex = 0;
            let cardDragStartX = 0;
            let cardIsDragging = false;
            const cardSwipeThreshold = 50;

            const EXCHANGE_RATE_API_URL = 'https://api.exchangerate-api.com/v4/latest/USD';
            const CACHE_DURATION_MS = 60 * 60 * 1000;

            function formatShares(value) { return Number(value.toFixed(4)); }
            function formatPercentage(value) {
                if (isNaN(value) || !isFinite(value)) return '';
                const sign = value >= 0 ? '+' : '';
                return `${sign}${value.toFixed(2)}%`;
            }
            function getTransactionResultUSD(tx) {
                return (tx.salePrice !== null && !isNaN(tx.salePrice)) ? (tx.salePrice * tx.shares) - (tx.purchasePrice * tx.shares) : 0;
            }

            async function fetchExchangeRates() {
                 const lastFetchTime = localStorage.getItem('exchangeRateFetchTime');
                const cachedRates = localStorage.getItem('exchangeRates');

                if (cachedRates && lastFetchTime && (Date.now() - parseInt(lastFetchTime)) < CACHE_DURATION_MS) {
                    try {
                        exchangeRates = JSON.parse(cachedRates);
                        console.log("Using cached exchange rates:", exchangeRates);
                        return exchangeRates;
                    } catch (e) {
                        console.error("Error parsing cached rates:", e);
                        localStorage.removeItem('exchangeRates');
                        localStorage.removeItem('exchangeRateFetchTime');
                    }
                }

                console.log("Fetching fresh exchange rates...");
                try {
                    const response = await fetch(EXCHANGE_RATE_API_URL);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();

                    if (data && data.rates && data.rates.GTQ) {
                        exchangeRates = { USD: 1, GTQ: data.rates.GTQ };
                        localStorage.setItem('exchangeRates', JSON.stringify(exchangeRates));
                        localStorage.setItem('exchangeRateFetchTime', Date.now().toString());
                        console.log("Fetched and cached new rates:", exchangeRates);
                        return exchangeRates;
                    } else {
                        throw new Error("Invalid API response format");
                    }
                } catch (error) {
                    console.error("Failed to fetch exchange rates:", error);
                    if (cachedRates) {
                        try {
                            exchangeRates = JSON.parse(cachedRates);
                            console.warn("Using stale cached rates due to fetch error:", exchangeRates);
                            return exchangeRates;
                        } catch(e) { console.error("Error parsing stale cached rates:", e); }
                    }
                    exchangeRates = { USD: 1, GTQ: 7.8 };
                    alert("No se pudieron obtener las tasas de cambio actuales. Usando valores por defecto (1 USD = 7.8 GTQ).");
                    return exchangeRates;
                }
            }

            function convertValue(valueInUSD, targetCurrency) {
                if (isNaN(valueInUSD) || valueInUSD === null) return 0;
                const rate = exchangeRates[targetCurrency] || 1;
                return valueInUSD * rate;
            }
            function formatCurrency(valueInUSD) {
                const convertedValue = convertValue(valueInUSD, currentCurrency);
                const symbol = currentCurrency === 'GTQ' ? 'Q' : '$';
                if (isNaN(convertedValue)) {
                    console.warn("formatCurrency received NaN for valueInUSD:", valueInUSD);
                    return `${symbol}0.00`;
                }
                const isNegative = valueInUSD < -0.0001;
                const absoluteFormattedValue = Math.abs(convertedValue).toFixed(2);
                return isNegative ? `-${symbol}${absoluteFormattedValue}` : `${symbol}${absoluteFormattedValue}`;
            }
             function formatChartAxisValue(valueInUSD) {
                const convertedValue = convertValue(valueInUSD, currentCurrency);
                if (isNaN(convertedValue)) return '0';
                return convertedValue.toFixed(Math.abs(convertedValue) >= 10 || Math.abs(convertedValue) < 0.01 ? 0 : 2);
             }

             function loadTransactions() {
                 const storedTransactions = localStorage.getItem('stockTransactions');
                 if (storedTransactions) {
                     try {
                         transactions = JSON.parse(storedTransactions);
                         transactions.forEach(tx => {
                             tx.dateTime = new Date(tx.dateTime);
                             tx.purchasePrice = parseFloat(tx.purchasePrice);
                             tx.shares = parseFloat(tx.shares);
                             tx.salePrice = tx.salePrice !== null && tx.salePrice !== undefined ? parseFloat(tx.salePrice) : null;
                             if (!tx.id) tx.id = tx.dateTime.getTime().toString() + Math.random().toString(16).slice(2);
                         });
                         transactions.sort((a, b) => a.dateTime - b.dateTime);
                     } catch (e) {
                         console.error("Error parsing transactions from localStorage:", e);
                         transactions = [];
                         localStorage.removeItem('stockTransactions');
                     }
                 } else { transactions = []; }
             }
             function saveTransactions() {
                 transactions.sort((a, b) => a.dateTime - b.dateTime);
                 localStorage.setItem('stockTransactions', JSON.stringify(transactions));
             }
             function findTransactionById(id) {
                 return transactions.find(tx => tx.id === id);
             }
             function deleteTransaction(id) {
                 const index = transactions.findIndex(tx => tx.id === id);
                 if (index > -1) {
                     transactions.splice(index, 1);
                     saveTransactions();
                     updateUI();
                 } else { console.warn("Tried to delete non-existent transaction ID:", id); }
             }

            function initializeChart() {
                 if (stockChart) { stockChart.destroy(); }
                 const ctx = chartCanvas.getContext('2d');
                 const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-grid-color-val').trim();
                 const tickColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-tick-color-val').trim();
                 const lineBorderColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-line-color-val').trim();
                 const gradient = ctx.createLinearGradient(0, 0, 0, 180);
                 gradient.addColorStop(0, 'rgba(38, 166, 154, 0.55)');
                 gradient.addColorStop(0.8, 'rgba(38, 166, 154, 0.05)');
                 gradient.addColorStop(1, 'rgba(38, 166, 154, 0.0)');

                 stockChart = new Chart(ctx, {
                     type: 'line',
                     data: { labels: [], datasets: [{ label: `Resultado (${currentCurrency})`, data: [], borderColor: lineBorderColor, borderWidth: 2, pointRadius: 0, pointHoverRadius: 5, pointHitRadius: 10, tension: 0.3, fill: true, backgroundColor: gradient }] },
                     options: {
                         responsive: true, maintainAspectRatio: false,
                         scales: {
                             y: { beginAtZero: false, position: 'right', grid: { color: gridColor, drawBorder: false }, ticks: { color: tickColor, padding: 10, maxTicksLimit: 5, callback: (value) => formatChartAxisValue(value) } },
                             x: { grid: { display: false, drawBorder: false }, ticks: { color: tickColor, padding: 10, maxRotation: 0, autoSkip: true, maxTicksLimit: 7, callback: function(value) { const date = new Date(this.getLabelForValue(value)); return date.toLocaleTimeString([], { hour: 'numeric', minute:'2-digit', hour12: false }).split(':')[0]; } } }
                         },
                         plugins: {
                             legend: { display: false },
                             tooltip: { enabled: true, mode: 'index', intersect: false, backgroundColor: 'rgba(0,0,0,0.8)', titleFont: { size: 14 }, bodyFont: { size: 12 }, padding: 10, displayColors: false,
                                 callbacks: {
                                     label: (context) => `Resultado: ${formatCurrency(context.parsed.y)}`,
                                     title: (tooltipItems) => new Date(tooltipItems[0].label).toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short'})
                                 }
                             }
                         },
                         interaction: { mode: 'index', axis: 'x', intersect: false }
                     }
                 });
             }
             function updateChart() {
                 if (!stockChart) initializeChart();
                 if (!stockChart) return;

                 let cumulativeResultUSD = 0;
                 const chartData = transactions.map(tx => {
                     cumulativeResultUSD += getTransactionResultUSD(tx);
                     return { x: tx.dateTime.toISOString(), y: cumulativeResultUSD };
                 });
                 if (chartData.length === 1) {
                    const firstTxTime = new Date(transactions[0].dateTime);
                    const startTime = new Date(firstTxTime.getTime() - 60000);
                    chartData.unshift({ x: startTime.toISOString(), y: 0 });
                 } else if (chartData.length === 0) {
                    const now = new Date(); const startTime = new Date(now.getTime() - 60000);
                    chartData.push({ x: startTime.toISOString(), y: 0 });
                 }

                 stockChart.data.labels = chartData.map(d => d.x);
                 stockChart.data.datasets[0].data = chartData.map(d => d.y);
                 stockChart.data.datasets[0].label = `Resultado Acumulado (${currentCurrency})`;
                 stockChart.options.scales.y.ticks.color = getComputedStyle(document.documentElement).getPropertyValue('--chart-tick-color-val').trim();
                 stockChart.options.scales.y.grid.color = getComputedStyle(document.documentElement).getPropertyValue('--chart-grid-color-val').trim();
                 stockChart.options.scales.x.ticks.color = getComputedStyle(document.documentElement).getPropertyValue('--chart-tick-color-val').trim();
                 stockChart.data.datasets[0].borderColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-line-color-val').trim();
                 stockChart.options.scales.y.ticks.callback = (value) => formatChartAxisValue(value);
                 stockChart.options.plugins.tooltip.callbacks.label = (context) => `Resultado: ${formatCurrency(context.parsed.y)}`;
                 stockChart.update();
            }

             function handleDragStart(event) {
                if (event.type === 'mousedown' && event.button !== 0) return;
                const targetItem = event.target.closest('.transaction-item');
                if (!targetItem) return;
                draggedItemElement = targetItem;
                draggedItemWrapper = targetItem.closest('.transaction-item-wrapper');
                if (!draggedItemWrapper) return;
                dragStartX = event.touches ? event.touches[0].clientX : event.clientX;
                currentDragX = dragStartX;
                isDragging = false;
                document.body.style.userSelect = 'none';
             }
             function handleDragMove(event) {
                if (!draggedItemElement) return;
                if (event.touches && event.cancelable) { event.preventDefault(); }
                currentDragX = event.touches ? event.touches[0].clientX : event.clientX;
                const diffX = currentDragX - dragStartX;
                if (!isDragging && Math.abs(diffX) > dragStartThreshold) {
                    isDragging = true;
                    draggedItemElement.classList.add('dragging');
                    draggedItemElement.style.transition = 'none';
                }
                if (isDragging) {
                    draggedItemElement.style.transform = `translateX(${diffX}px)`;
                    const background = draggedItemWrapper.querySelector('.transaction-item-swipe-background');
                    if (background) {
                        const swipeRatio = Math.min(1, Math.abs(diffX) / (swipeThreshold * 1.5));
                        background.style.opacity = swipeRatio;
                        if (diffX > dragStartThreshold) { background.className = 'transaction-item-swipe-background swipe-edit'; background.innerHTML = `<span>EDITAR</span><span></span>`; }
                        else if (diffX < -dragStartThreshold) { background.className = 'transaction-item-swipe-background swipe-delete'; background.innerHTML = `<span></span><span>ELIMINAR</span>`; }
                        else { background.style.opacity = 0; }
                    }
                }
             }
             function handleDragEnd(event) {
                if (!isDragging) { resetDragState(); return; }
                const diffX = currentDragX - dragStartX;
                const transactionId = draggedItemWrapper?.dataset?.id;
                if (!transactionId) {
                    console.error("Missing transaction ID on dragged item wrapper.");
                    if (draggedItemElement) snapBack(draggedItemElement);
                    resetDragState(); return;
                }
                 if (draggedItemElement) { draggedItemElement.style.transition = 'transform 0.1s ease-out'; }

                if (diffX > swipeThreshold) {
                    editingItemId = transactionId;
                    openEditModal(transactionId);
                } else if (diffX < -swipeThreshold) {
                    if (confirm(`¿Seguro que quieres eliminar esta transacción (${findTransactionById(transactionId)?.ticker || 'N/A'})?`)) {
                        if (draggedItemWrapper) {
                            draggedItemWrapper.style.transition = 'height 0.2s ease-out, opacity 0.2s ease-out, margin 0.2s ease-out, padding 0.2s ease-out';
                            draggedItemWrapper.style.height = '0px';
                            draggedItemWrapper.style.opacity = '0';
                            draggedItemWrapper.style.margin = '0';
                            draggedItemWrapper.style.padding = '0';
                            setTimeout(() => { deleteTransaction(transactionId); }, 200);
                        } else { deleteTransaction(transactionId); }
                    } else { if (draggedItemElement) snapBack(draggedItemElement); }
                } else { if (draggedItemElement) snapBack(draggedItemElement); }
                resetDragState();
            }
             function resetDragState() {
                 if (draggedItemElement) {
                     draggedItemElement.classList.remove('dragging');
                     draggedItemElement.style.transition = 'transform 0.1s ease-out';
                 }
                 isDragging = false;
                 draggedItemElement = null;
                 if (!editingItemId) { draggedItemWrapper = null; }
                 dragStartX = 0; currentDragX = 0;
                 document.body.style.userSelect = '';
             }
             function snapBack(item) {
                 if (!item) return;
                 item.style.transform = 'translateX(0px)';
                 const wrapper = item.closest('.transaction-item-wrapper');
                 if (wrapper) {
                     const background = wrapper.querySelector('.transaction-item-swipe-background');
                     if (background) { background.style.transition = 'opacity 0.1s ease-out'; background.style.opacity = 0; }
                 }
             }
             function attachSwipeListeners(wrapperElement) {
                 wrapperElement.addEventListener('touchstart', handleDragStart, { passive: true });
                 wrapperElement.addEventListener('touchmove', handleDragMove, { passive: false });
                 wrapperElement.addEventListener('touchend', handleDragEnd);
                 wrapperElement.addEventListener('touchcancel', handleDragEnd);
                 wrapperElement.addEventListener('mousedown', handleDragStart);
             }
             document.addEventListener('mousemove', (e) => { if(isDragging) { handleDragMove(e); } });
             document.addEventListener('mouseup', (e) => { if(isDragging) { handleDragEnd(e); } });

             function openAddModal() {
                 modalTitle.textContent = "Añadir Nueva Transacción";
                 modalSubmitBtn.textContent = "Añadir";
                 addTransactionForm.reset();
                 editTransactionIdInput.value = '';
                 editingItemId = null;
                 const now = new Date();
                 now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                 document.getElementById('transactionDateTime').value = now.toISOString().slice(0, 16);
                 modal.style.display = 'flex';
                 document.getElementById('ticker').focus();
             }
             function openEditModal(transactionId) {
                 const tx = findTransactionById(transactionId);
                 if (!tx) {
                    console.error("Cannot open edit modal: Transaction not found for ID", transactionId);
                    if (draggedItemElement) snapBack(draggedItemElement);
                    resetDragState(); return;
                 }
                 modalTitle.textContent = "Editar Transacción";
                 modalSubmitBtn.textContent = "Actualizar";
                 addTransactionForm.reset();
                 editTransactionIdInput.value = tx.id;
                 editingItemId = tx.id;
                 document.getElementById('ticker').value = tx.ticker;
                 document.getElementById('assetType').value = tx.assetType;
                 document.getElementById('purchasePrice').value = tx.purchasePrice;
                 document.getElementById('shares').value = tx.shares;
                 document.getElementById('salePrice').value = tx.salePrice ?? '';
                 const localDateTime = new Date(tx.dateTime.getTime() - (tx.dateTime.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
                 document.getElementById('transactionDateTime').value = localDateTime;
                 modal.style.display = 'flex';
                 document.getElementById('ticker').focus();
             }
             function closeModal() {
                 modal.style.display = 'none';
                 if (editingItemId) {
                     const wrapperToSnap = transactionListContainer.querySelector(`.transaction-item-wrapper[data-id="${editingItemId}"]`);
                     if (wrapperToSnap) {
                         const itemToSnap = wrapperToSnap.querySelector('.transaction-item');
                         if (itemToSnap) { snapBack(itemToSnap); }
                     }
                 }
                 editingItemId = null;
                 draggedItemWrapper = null;
             }

             function applyCardSkin(index) {
                 financeCard.classList.remove(...cardSkins);
                 financeCard.classList.add(cardSkins[index]);
                 currentSkinIndex = index;
                 localStorage.setItem('selectedCardSkinIndex', index);
             }

             function handleCardDragStart(event) {
                 if (event.target.closest('button, a, input, select')) return;
                 if (event.type === 'mousedown' && event.button !== 0) return;
                 cardDragStartX = event.touches ? event.touches[0].clientX : event.clientX;
                 cardIsDragging = true;
                 financeCard.style.cursor = 'grabbing';
             }

             function handleCardDragEnd(event) {
                 if (!cardIsDragging) return;
                 cardIsDragging = false;
                 financeCard.style.cursor = 'grab';

                 const cardDragEndX = event.changedTouches ? event.changedTouches[0].clientX : event.clientX;
                 const diffX = cardDragEndX - cardDragStartX;

                 if (Math.abs(diffX) > cardSwipeThreshold) {
                     if (diffX > 0) {
                         const newIndex = (currentSkinIndex - 1 + cardSkins.length) % cardSkins.length;
                         applyCardSkin(newIndex);
                     } else {
                         const newIndex = (currentSkinIndex + 1) % cardSkins.length;
                         applyCardSkin(newIndex);
                     }
                 }
                 cardDragStartX = 0;
             }

            function updateUI() {
                transactionListContainer.innerHTML = '';
                let totalInvestmentUSD = 0;
                let totalCapitalizationUSD = 0;
                let costOfSoldItemsUSD = 0;
                let revenueFromSoldItemsUSD = 0;

                transactions.forEach(tx => {
                    totalInvestmentUSD += (tx.purchasePrice * tx.shares);
                    if (tx.salePrice !== null && !isNaN(tx.salePrice)) {
                        totalCapitalizationUSD += (tx.salePrice * tx.shares);
                        costOfSoldItemsUSD += (tx.purchasePrice * tx.shares);
                        revenueFromSoldItemsUSD += (tx.salePrice * tx.shares);
                    }
                });

                totalInvestmentEl.textContent = formatCurrency(totalInvestmentUSD);
                totalCapitalizationEl.textContent = formatCurrency(totalCapitalizationUSD);

                let profitLossOnSoldUSD = revenueFromSoldItemsUSD - costOfSoldItemsUSD;
                let percentageChange = costOfSoldItemsUSD !== 0 ? (profitLossOnSoldUSD / costOfSoldItemsUSD) * 100 : 0;

                capitalizationChangeEl.textContent = formatPercentage(percentageChange);
                capitalizationChangeEl.className = 'change';
                if (percentageChange > 0.01) capitalizationChangeEl.classList.add('positive');
                else if (percentageChange < -0.01) capitalizationChangeEl.classList.add('negative');
                else capitalizationChangeEl.classList.add('neutral');

                const displayTransactions = [...transactions].reverse();
                const limitedTransactions = displayTransactions.slice(0, 5);

                if (transactions.length === 0) {
                    transactionListContainer.innerHTML = '<p class="no-transactions">Añade tu primera transacción o desliza para editar/eliminar.</p>';
                } else {
                    limitedTransactions.forEach(tx => {
                        const resultUSD = getTransactionResultUSD(tx);
                        let resultClass = 'neutral';
                        if (resultUSD > 0.001) resultClass = 'positive';
                        else if (resultUSD < -0.001) resultClass = 'negative';

                        const wrapper = document.createElement('div');
                        wrapper.classList.add('transaction-item-wrapper');
                        wrapper.dataset.id = tx.id;

                        const swipeBg = document.createElement('div');
                        swipeBg.className = 'transaction-item-swipe-background';
                        swipeBg.style.opacity = 0;
                        wrapper.appendChild(swipeBg);

                        const item = document.createElement('div');
                        item.classList.add('transaction-item');

                        const hasSalePrice = tx.salePrice !== null && !isNaN(tx.salePrice);
                        const resultText = hasSalePrice ? formatCurrency(resultUSD) : '';

                        item.innerHTML = `
                            <span>${tx.ticker.toUpperCase()}</span>
                            <span class="result ${resultClass}">${resultText}</span>
                            <span>${tx.assetType || 'Activo'}</span>
                            <span>${formatShares(tx.shares)}</span>
                        `;

                        if (!hasSalePrice) {
                           item.classList.add('no-result');
                           item.children[1].style.display = 'none';
                           item.children[2].style.textAlign = 'right';
                        } else {
                           item.children[2].style.textAlign = 'left';
                        }

                        wrapper.appendChild(item);
                        transactionListContainer.appendChild(wrapper);
                        attachSwipeListeners(wrapper);
                    });
                    if (transactions.length > 5) {
                         const moreMsg = document.createElement('p');
                         moreMsg.textContent = `Mostrando las últimas 5 de ${transactions.length} transacciones.`;
                         moreMsg.style.textAlign = 'center';
                         moreMsg.style.fontSize = '0.8em';
                         moreMsg.style.color = 'var(--text-secondary-color)';
                         moreMsg.style.marginTop = '10px';
                         transactionListContainer.appendChild(moreMsg);
                    }
                }
                updateChart();
            }

            addTransactionBtn.addEventListener('click', openAddModal);
            removeTransactionBtn.addEventListener('click', () => {
                if (transactions.length === 0) { alert("No hay transacciones para eliminar."); return; }
                if (confirm("¿Seguro que quieres eliminar TODAS las transacciones? Esta acción no se puede deshacer.")) {
                    transactions = [];
                    saveTransactions();
                    updateUI();
                }
            });
            closeModalBtn.addEventListener('click', closeModal);
            cancelModalBtn.addEventListener('click', closeModal);
            window.addEventListener('click', (event) => { if (event.target === modal) { closeModal(); } });

            addTransactionForm.addEventListener('submit', (event) => {
                event.preventDefault();
                const formData = new FormData(event.target);
                const editId = formData.get('editTransactionId');
                const ticker = formData.get('ticker')?.trim().toUpperCase();
                const assetType = formData.get('assetType')?.trim();
                const purchasePriceStr = formData.get('purchasePrice');
                const sharesStr = formData.get('shares');
                const salePriceStr = formData.get('salePrice');
                const dateTimeStr = formData.get('transactionDateTime');

                if (!ticker || !assetType || !purchasePriceStr || !sharesStr || !dateTimeStr) {
                     alert("Por favor, rellena todos los campos obligatorios (Ticker, Tipo, Precio Compra, Acciones, Fecha)."); return;
                }

                const transactionData = {
                    ticker: ticker, assetType: assetType,
                    purchasePrice: parseFloat(purchasePriceStr), shares: parseFloat(sharesStr),
                    salePrice: (salePriceStr && !isNaN(parseFloat(salePriceStr))) ? parseFloat(salePriceStr) : null,
                    dateTime: new Date(dateTimeStr)
                };

                if (isNaN(transactionData.purchasePrice) || transactionData.purchasePrice < 0 ||
                    isNaN(transactionData.shares) || transactionData.shares <= 0 ||
                    (transactionData.salePrice !== null && (isNaN(transactionData.salePrice) || transactionData.salePrice < 0)) ||
                    isNaN(transactionData.dateTime.getTime())) {
                    alert("Por favor, introduce valores numéricos válidos y una fecha correcta."); return;
                }

                if (editId) {
                    const index = transactions.findIndex(tx => tx.id === editId);
                    if (index > -1) { transactions[index] = { ...transactions[index], ...transactionData }; }
                    else { console.error("Transaction ID not found for editing:", editId); alert("Error: No se pudo encontrar la transacción para actualizar."); closeModal(); return; }
                } else {
                    transactionData.id = Date.now().toString() + Math.random().toString(16).slice(2);
                    transactions.push(transactionData);
                }
                saveTransactions(); updateUI(); closeModal();
            });

            currencySelector.addEventListener('change', async (event) => {
                currentCurrency = event.target.value;
                localStorage.setItem('selectedCurrency', currentCurrency);
                await fetchExchangeRates();
                updateUI();
            });

            financeCard.addEventListener('touchstart', handleCardDragStart, { passive: true });
            financeCard.addEventListener('touchend', handleCardDragEnd);
            financeCard.addEventListener('touchcancel', handleCardDragEnd);
            financeCard.addEventListener('mousedown', handleCardDragStart);
            document.addEventListener('mouseup', (e) => { if(cardIsDragging) { handleCardDragEnd(e); } });

            async function initializeApp() {
                currentCurrency = localStorage.getItem('selectedCurrency') || 'USD';
                currencySelector.value = currentCurrency;

                const savedSkinIndex = parseInt(localStorage.getItem('selectedCardSkinIndex') || '0');
                currentSkinIndex = (savedSkinIndex >= 0 && savedSkinIndex < cardSkins.length) ? savedSkinIndex : 0;
                applyCardSkin(currentSkinIndex);

                loadTransactions();
                initializeChart();
                await fetchExchangeRates();
                updateUI();
            }

            initializeApp();

        });
    </script>
</body>
</html>
